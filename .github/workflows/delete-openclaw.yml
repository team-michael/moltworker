name: Delete OpenClaw

on:
  workflow_dispatch:
    inputs:
      username:
        description: "Username of the OpenClaw instance to delete"
        required: true
        type: string
      delete_r2_bucket:
        description: "Also delete the R2 bucket and all stored data"
        required: false
        type: boolean
        default: false

jobs:
  delete:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Validate inputs
        run: |
          USERNAME="${{ inputs.username }}"
          if ! echo "$USERNAME" | grep -qE '^[a-z0-9]([a-z0-9-]*[a-z0-9])?$'; then
            echo "::error::Invalid username '${USERNAME}'. Must be lowercase alphanumeric with optional hyphens."
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Delete openclaw worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          WORKER_NAME="openclaw-${{ inputs.username }}"
          echo "Deleting worker: ${WORKER_NAME}"
          npx wrangler delete --name "$WORKER_NAME" --force

      - name: Delete R2 bucket
        if: inputs.delete_r2_bucket
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          R2_BUCKET="openclaw-${{ inputs.username }}-data"
          echo "Deleting R2 bucket: ${R2_BUCKET}"
          npx wrangler r2 bucket delete "$R2_BUCKET" 2>&1 || echo "::warning::Could not delete bucket (may not be empty or may not exist)"

      - name: Deletion summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ## OpenClaw Deleted

          | Item | Status |
          |------|--------|
          | **Worker** \`openclaw-${{ inputs.username }}\` | Deleted |
          | **R2 Bucket** \`openclaw-${{ inputs.username }}-data\` | ${{ inputs.delete_r2_bucket && 'Deleted' || 'Retained' }} |
          EOF
