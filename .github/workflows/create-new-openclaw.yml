name: Create New OpenClaw

on:
  workflow_dispatch:
    inputs:
      username:
        description: "Username for the OpenClaw instance (lowercase alphanumeric, hyphens allowed)"
        required: true
        type: string
      model:
        description: "AI model for Cloudflare AI Gateway (e.g. workers-ai/@cf/meta/llama-3.3-70b-instruct-fp8-fast, openai/gpt-4o, bedrock/anthropic.claude-3-5-sonnet-20241022-v2:0)"
        required: true
        type: string
      telegram_bot_token:
        description: "Telegram Bot Token for this instance"
        required: true
        type: string
      sandbox_sleep_after:
        description: "Container sleep timeout in minutes, or 'never' (default: 30)"
        required: false
        type: string
        default: "30"

jobs:
  create:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Validate inputs
        run: |
          USERNAME="${{ inputs.username }}"
          MODEL="${{ inputs.model }}"

          if ! echo "$USERNAME" | grep -qE '^[a-z0-9]([a-z0-9-]*[a-z0-9])?$'; then
            echo "::error::Invalid username '${USERNAME}'. Must be lowercase alphanumeric with optional hyphens, cannot start/end with hyphen."
            exit 1
          fi

          if ! echo "$MODEL" | grep -qE '^(workers-ai|openai|bedrock)/'; then
            echo "::error::Invalid model format '${MODEL}'. Must start with workers-ai/, openai/, or bedrock/"
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Configure wrangler for user namespace
        run: |
          WORKER_NAME="openclaw-${{ inputs.username }}"
          R2_BUCKET="openclaw-${{ inputs.username }}-data"

          echo "Worker name: ${WORKER_NAME}"
          echo "R2 bucket:   ${R2_BUCKET}"

          sed -i "s|\"name\": \"moltbot-sandbox\"|\"name\": \"${WORKER_NAME}\"|" wrangler.jsonc
          sed -i "s|\"bucket_name\": \"moltbot-data\"|\"bucket_name\": \"${R2_BUCKET}\"|" wrangler.jsonc

      - name: Create R2 bucket
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          npx wrangler r2 bucket create "openclaw-${{ inputs.username }}-data" 2>&1 || echo "::warning::Bucket may already exist, continuing..."

      - name: Generate tokens
        id: token
        run: |
          GATEWAY_TOKEN=$(openssl rand -hex 32)
          echo "::add-mask::${GATEWAY_TOKEN}"
          echo "gateway_token=${GATEWAY_TOKEN}" >> "$GITHUB_OUTPUT"

          CDP_SECRET=$(openssl rand -hex 32)
          echo "::add-mask::${CDP_SECRET}"
          echo "cdp_secret=${CDP_SECRET}" >> "$GITHUB_OUTPUT"

      - name: Deploy moltworker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: npx wrangler deploy

      - name: Set worker secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          WORKER_NAME="openclaw-${{ inputs.username }}"

          # --- Cloudflare Account ID (shared: AI Gateway + R2 + wrangler) ---
          echo "${{ secrets.CF_ACCOUNT_ID }}" | npx wrangler secret put CF_ACCOUNT_ID              --name "$WORKER_NAME"
          echo "${{ secrets.CF_ACCOUNT_ID }}" | npx wrangler secret put CF_AI_GATEWAY_ACCOUNT_ID   --name "$WORKER_NAME"

          # --- AI Gateway configuration ---
          echo "${{ secrets.CLOUDFLARE_AI_GATEWAY_API_KEY }}" | npx wrangler secret put CLOUDFLARE_AI_GATEWAY_API_KEY --name "$WORKER_NAME"
          echo "${{ secrets.CF_AI_GATEWAY_GATEWAY_ID }}"       | npx wrangler secret put CF_AI_GATEWAY_GATEWAY_ID       --name "$WORKER_NAME"
          echo "${{ inputs.model }}"                           | npx wrangler secret put CF_AI_GATEWAY_MODEL             --name "$WORKER_NAME"

          # --- Telegram ---
          echo "${{ inputs.telegram_bot_token }}" | npx wrangler secret put TELEGRAM_BOT_TOKEN --name "$WORKER_NAME"

          # --- Gateway authentication token ---
          echo "${{ steps.token.outputs.gateway_token }}" | npx wrangler secret put MOLTBOT_GATEWAY_TOKEN --name "$WORKER_NAME"

          # --- R2 persistence ---
          echo "${{ secrets.R2_ACCESS_KEY_ID }}"     | npx wrangler secret put R2_ACCESS_KEY_ID     --name "$WORKER_NAME"
          echo "${{ secrets.R2_SECRET_ACCESS_KEY }}"  | npx wrangler secret put R2_SECRET_ACCESS_KEY  --name "$WORKER_NAME"

          # R2 bucket name override (per-user isolation)
          echo "openclaw-${{ inputs.username }}-data" | npx wrangler secret put R2_BUCKET_NAME --name "$WORKER_NAME"

          # --- CDP (browser automation) ---
          echo "${{ steps.token.outputs.cdp_secret }}" | npx wrangler secret put CDP_SECRET  --name "$WORKER_NAME"
          echo "https://openclaw-${{ inputs.username }}.notifly.workers.dev" | npx wrangler secret put WORKER_URL --name "$WORKER_NAME"

          # --- Container sleep timeout ---
          SLEEP_AFTER="${{ inputs.sandbox_sleep_after }}"
          if [ "$SLEEP_AFTER" = "never" ]; then
            echo "never" | npx wrangler secret put SANDBOX_SLEEP_AFTER --name "$WORKER_NAME"
          else
            echo "${SLEEP_AFTER}m" | npx wrangler secret put SANDBOX_SLEEP_AFTER --name "$WORKER_NAME"
          fi

          # --- Cloudflare Access ---
          echo "${{ secrets.CF_ACCESS_TEAM_DOMAIN }}" | npx wrangler secret put CF_ACCESS_TEAM_DOMAIN --name "$WORKER_NAME"
          echo "${{ secrets.CF_ACCESS_AUD }}"          | npx wrangler secret put CF_ACCESS_AUD          --name "$WORKER_NAME"

      - name: Deployment summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ## OpenClaw Created

          | Item | Value |
          |------|-------|
          | **Worker** | \`openclaw-${{ inputs.username }}\` |
          | **R2 Bucket** | \`openclaw-${{ inputs.username }}-data\` |
          | **Model** | \`${{ inputs.model }}\` |
          | **Telegram** | Configured |
          | **Sleep After** | \`${{ inputs.sandbox_sleep_after }}m\` |
          | **CDP** | Enabled (secret auto-generated) |
          | **Gateway Token** | Auto-generated (stored as worker secret) |
          EOF
